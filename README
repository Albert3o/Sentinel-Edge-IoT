# Sentinel-Edge-IoT: 基于 Linux 网关与分布式集群的入侵检测系统

Sentinel-Edge-IoT 是一个结合了边缘计算与分布式协同逻辑的物联网安防系统。该系统由一个高性能的 **Linux 网关 (Raspberry Pi)** 和多个高性能 **传感器节点 (ESP32)** 组成。通过自定义的轻量级 UDP 协议，系统实现了低延迟的入侵检测、去中心化的 Master 选举以及自动化的云端告警。

## 🌟 系统核心特性

### 1. 高性能 Linux 网关 (RPi 端)
* **I/O 多路复用 (Epoll & Timerfd):** 核心引擎基于 epoll 构建，实现O(1)效率的并发包处理；利用 timerfd 实现确定性的周期性任务（如节点超时审计），避免了传统 sleep 带来的阻塞。
* **多进程守护架构 (Fault Tolerance):** 采用父子进程监控模型。主进程作为守护进程通过 fork 和 waitpid 监控工作进程，支持异常退出后的自动重启与平滑的信号处理（SIGTERM/SIGINT）。
* **异步任务解耦 (Worker Pool):** 内置线程池中间件，将实时性要求高的 UDP 接收逻辑与高延迟的云端 API（Firebase/libcurl）操作解耦，确保系统在高负载下依然保持实时响应。
* **线程安全管理:** 使用互斥锁（Mutex）保护全局节点内存表，确保在多线程环境下节点状态更新与清理的原子性。

### 2. 分布式集群逻辑 (ESP32 端)
* **双核任务并行 (Task Pinning):** 利用 FreeRTOS 将网络协议栈（Core 0）与传感器采样/选举逻辑（Core 1）物理隔离，消除网络抖动对采样频率的影响。
* **基于权重的 Master 选举:** 实现了动态角色切换算法。节点根据 PIR (人体红外) 和 LDR (光照) 传感器的实时数据计算威胁分，自动选举 Master 节点。
* **数据提纯 (Master Relay):** 采用 Master 重启逻辑，仅允许集群中权重最高的节点上报告警，有效减少了 30% 以上的冗余网络流量。

### 3. 网络协议与通信优化
* **动态网关发现:** 实现了“广播转单播”的握手机制。节点初始通过广播寻找网关，在接收到网关的 ACK 后自动切换为单播，显著降低局域网带宽负载。
* **可靠性设计:** 协议包含版本校验、心跳维持和超时剔除机制，确保了分布式集群的鲁棒性。

## 📂 项目结构
.
├── gateway                      # 【Linux 网关端】基于树莓派/Linux 的高性能中继
│   ├── bin                      # 二进制可执行文件目录
│   │   └── sentinel_edge_iot
│   ├── include
│   │   ├── cloud_client.h       # 云端交互接口
│   │   ├── gateway_core.h       # 网络核心引擎（Epoll 监听、Timerfd 定义）
│   │   ├── node_manager.h       # 节点表管理（维护存活 ESP32 节点的内存链表）
│   │   ├── protocol.h           # 通讯协议定义（定义 UDP 包结构体，需与传感器端对齐）
│   │   ├── utils.h              # 工具函数（日志系统、系统错误处理、守护进程初始化）
│   │   └── worker_pool.h        # 线程池框架（定义任务队列与工作线程接口）
│   ├── Makefile
│   ├── obj                      # 中间目标文件目录（加快增量编译速度）
│   │   ├── ... .o
│   └── src                      # 核心源代码目录
│       ├── cloud_client.c       # 异步上传逻辑
│       ├── gateway_core.c       # 高性能 IO 多路复用实现
│       ├── main.c               # 程序入口
│       ├── node_manager.c       # 线程安全的数据操作
│       ├── utils.c              # 日志与错误记录的具体实现
│       └── worker_pool.c        # 生产者-消费者模型的线程池实现
├── README
└── sensor_terminal              # 【传感器终端】基于 ESP32 的分布式节点
    ├── config.h                 # 硬件配置
    ├── election_manager.cpp     # 权重选举算法实现
    ├── election_manager.h       # 选举管理器类定义
    ├── iot_node.ino             # 入口函数
    ├── network_manager.cpp      # UDP 网络抽象层（实现广播寻址与单播转换逻辑）
    ├── network_manager.h        # 网络管理器类定义
    ├── protocol.h               # 通讯协议定义（必须与网关端完全一致，确保二进制对齐）
    ├── sensor_manager.cpp       # 硬件感知层（PIR 去抖、LDR 采样与数据预处理）
    └── sensor_manager.h         # 传感器管理器类定义


## 🛠 技术栈

* **语言:** C, Modern C++
* **操作系统:** Linux (Debian/Ubuntu), FreeRTOS
* **系统编程:** Epoll, Timerfd, Pthreads, Fork/Wait, Signal Handling, Mutex
* **网络与协议:** UDP Socket, Custom Protocol, libcurl, cJSON
* **硬件平台:** Raspberry Pi, ESP32 (PIR & LDR 传感器)

## 🚀 快速开始

### 1. 网关编译与运行 (Linux)

bash
# 安装依赖
sudo apt-get install libcurl4-openssl-dev

# 编译
gcc -o gateway main.c gateway_core.c worker_pool.c node_manager.c cloud_client.c utils.c -lpthread -lcurl -lcjson -I.

# 以守护进程模式运行
./bin/sentinel_edge_iot -d



### 2. 固件部署 (ESP32)

使用 PlatformIO 或 Arduino IDE 烧录 firmware_esp32 目录下的源码。确保填写正确的 WiFi SSID 和密码。

## 📊 性能表现

* **系统响应:** 传感器触发到云端推送完成的端到端延迟 < 500ms。
* **并发能力:** 支持 50+ 节点同时在线且不影响主循环周期。
* **稳定性:** 在守护进程监控下，系统支持 24/7 无人值守运行，具备自动异常恢复功能。




